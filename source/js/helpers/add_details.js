'use strict';

let _ = require("lodash")

module.exports = function (stats) {
    let max_experience = 200000000,
        levels = [
            {level: 1, exp: 0},
            {level: 2, exp: 83},
            {level: 3, exp: 174},
            {level: 4, exp: 276},
            {level: 5, exp: 388},
            {level: 6, exp: 512},
            {level: 7, exp: 650},
            {level: 8, exp: 801},
            {level: 9, exp: 969},
            {level: 10, exp: 1154},
            {level: 11, exp: 1358},
            {level: 12, exp: 1584},
            {level: 13, exp: 1833},
            {level: 14, exp: 2107},
            {level: 15, exp: 2411},
            {level: 16, exp: 2746},
            {level: 17, exp: 3115},
            {level: 18, exp: 3523},
            {level: 19, exp: 3973},
            {level: 20, exp: 4470},
            {level: 21, exp: 5018},
            {level: 22, exp: 5624},
            {level: 23, exp: 6291},
            {level: 24, exp: 7028},
            {level: 25, exp: 7842},
            {level: 26, exp: 8740},
            {level: 27, exp: 9730},
            {level: 28, exp: 10824},
            {level: 29, exp: 12031},
            {level: 30, exp: 13363},
            {level: 31, exp: 14833},
            {level: 32, exp: 16456},
            {level: 33, exp: 18247},
            {level: 34, exp: 20224},
            {level: 35, exp: 22406},
            {level: 36, exp: 24815},
            {level: 37, exp: 27473},
            {level: 38, exp: 30408},
            {level: 39, exp: 33648},
            {level: 40, exp: 37224},
            {level: 41, exp: 41171},
            {level: 42, exp: 45529},
            {level: 43, exp: 50339},
            {level: 44, exp: 55649},
            {level: 45, exp: 61512},
            {level: 46, exp: 67983},
            {level: 47, exp: 75127},
            {level: 48, exp: 83014},
            {level: 49, exp: 91721},
            {level: 50, exp: 101333},
            {level: 51, exp: 111945},
            {level: 52, exp: 123660},
            {level: 53, exp: 136594},
            {level: 54, exp: 150872},
            {level: 55, exp: 166636},
            {level: 56, exp: 184040},
            {level: 57, exp: 203254},
            {level: 58, exp: 224466},
            {level: 59, exp: 247886},
            {level: 60, exp: 273742},
            {level: 61, exp: 302288},
            {level: 62, exp: 333804},
            {level: 63, exp: 368599},
            {level: 64, exp: 407015},
            {level: 65, exp: 449428},
            {level: 66, exp: 496254},
            {level: 67, exp: 547953},
            {level: 68, exp: 605032},
            {level: 69, exp: 668051},
            {level: 70, exp: 737627},
            {level: 71, exp: 814445},
            {level: 72, exp: 899257},
            {level: 73, exp: 992895},
            {level: 74, exp: 1096278},
            {level: 75, exp: 1210421},
            {level: 76, exp: 1336443},
            {level: 77, exp: 1475581},
            {level: 78, exp: 1629200},
            {level: 79, exp: 1798808},
            {level: 80, exp: 1986068},
            {level: 81, exp: 2192818},
            {level: 82, exp: 2421087},
            {level: 83, exp: 2673114},
            {level: 84, exp: 2951373},
            {level: 85, exp: 3258594},
            {level: 86, exp: 3597792},
            {level: 87, exp: 3972294},
            {level: 88, exp: 4385776},
            {level: 89, exp: 4842295},
            {level: 90, exp: 5346332},
            {level: 91, exp: 5902831},
            {level: 92, exp: 6517253},
            {level: 93, exp: 7195629},
            {level: 94, exp: 7944614},
            {level: 95, exp: 8771558},
            {level: 96, exp: 9684577},
            {level: 97, exp: 10692629},
            {level: 98, exp: 11805606},
            {level: 99, exp: 13034431},
            {level: 100, exp: 14391160},
            {level: 101, exp: 15889109},
            {level: 102, exp: 17542976},
            {level: 103, exp: 19368992},
            {level: 104, exp: 21385073},
            {level: 105, exp: 23611006},
            {level: 106, exp: 26068632},
            {level: 107, exp: 28782069},
            {level: 108, exp: 31777943},
            {level: 109, exp: 35085654},
            {level: 110, exp: 38737661},
            {level: 111, exp: 42769801},
            {level: 112, exp: 47221641},
            {level: 113, exp: 52136869},
            {level: 114, exp: 57563718},
            {level: 115, exp: 63555443},
            {level: 116, exp: 70170840},
            {level: 117, exp: 77474828},
            {level: 118, exp: 85539082},
            {level: 119, exp: 94442737},
            {level: 120, exp: 104273167},
            {level: 121, exp: 115126838},
            {level: 122, exp: 127110260},
            {level: 123, exp: 140341028},
            {level: 124, exp: 154948977},
            {level: 125, exp: 171077457},
            {level: 126, exp: 188884740},
            {level: 127, exp: max_experience}
        ],
        modified_stats = _.reject(stats, { skill: "overall" }),
        overall = _.find(stats, { skill: "overall" })

    _.map(modified_stats, (stat, stat_index) => {
        let { exp: stat_exp } = stat

        for(let index = 0; index < levels.length; index++) {
            let { exp: level_exp } = levels[index],
                { level: prev_level, exp: prev_exp } = levels[index - 1] ? levels[index - 1] : {level: 1, exp: 0}

            if(stat_exp < level_exp && stat_exp >= prev_exp) {
                stat.level_virtual = prev_level

                stat.exp_til_next_level = level_exp - stat_exp

                stat.level_progress = (1 - ((level_exp - stat_exp) / (level_exp - prev_exp))) * 100

                break;
            }
        }
    })

    modified_stats.unshift(overall)

    return modified_stats
}
